package com.jsp.footmap.controller;import com.jsp.footmap.model.ResponseUser;import com.jsp.footmap.model.User;import com.jsp.footmap.service.UserService;import com.jsp.footmap.utils.Response;import com.jsp.footmap.utils.jsonUtils;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Controller;import org.springframework.web.bind.annotation.*;import javax.servlet.http.Cookie;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import java.io.IOException;import java.util.HashMap;import java.util.List;import java.util.Map;@Controller@RequestMapping("/user")public class UserController {    private static final Logger logger = LoggerFactory.getLogger(UserController.class);    @Autowired    private UserService userService;    /**     * 查询所有用户     * @return     */    @RequestMapping(path = {"/findAllUser"}, method = {RequestMethod.GET})    @ResponseBody    public Response<List<ResponseUser>> findAllUser() {        try {            List<ResponseUser> users = userService.findAllUser();            return new Response(0, "所有用户信息", users);        } catch (Exception e) {            logger.error("findAllUser:" + e.getMessage());            return new Response(1, "查询失败");        }    }    @RequestMapping(path = {"/findUser"}, method = {RequestMethod.GET})    @ResponseBody    public Response getUser(@CookieValue("auth_token") String auth_token) {        try {            User user = userService.getUser(auth_token);            Map<String,String> map = new HashMap<String, String>();            map.put("nickname",user.getNickname());            map.put("manager", String.valueOf(user.getManager()));            return new Response<Map<String,String>>(0, "获取成功", map);        } catch (Exception e){            logger.error("getUser:" + e.getMessage());            return new Response(1, "获取失败");        }    }    /**     * 用户注册     * @return code 0: 成功，code 1失败     */    @RequestMapping(path = {"/reg"}, method = {RequestMethod.POST})    @ResponseBody    public Response userRegister(@RequestBody String jsonStr) {        try {            Map<String, String> jsonMap = jsonUtils.StrToMap(jsonStr);            String username = jsonMap.get("username");            String password = jsonMap.get("password");            String email = jsonMap.get("email");            Map<String, String > map = userService.userRegister(username, password, email);           // response.setHeader("Access-Control-Allow-Origin","*");            if (map.get("msg").equals("注册成功")) {                // msg为空代表 注册成功                return new Response(0, map.get("msg"));            } else {                return new Response(1, map.get("msg"));            }        } catch (Exception e) {            logger.error("userRegister:" + e.getMessage());            return new Response(1, "注册失败");        }    }    /**     * 用户登陆     * @param username     * @param password     * @return     */    @RequestMapping(path = "/login", method = {RequestMethod.GET})    @ResponseBody    public Response userLogin(@RequestParam("username") String username, @RequestParam("password") String password,                              HttpServletRequest request, HttpServletResponse response) {        try {            String ip = "";            //x-forwarded-for 防止用户通过代理修改ip            if (request.getHeader("x-forwarded-for") == null) {                ip = request.getRemoteAddr();            } else {                ip = request.getHeader("x-forwarded-for");            }            Map<String,String> map = userService.userLogin(username, password, ip);            if (map.containsKey("tokens")) {                Cookie cookie = new Cookie("auth_token", map.get("tokens"));                //同一应用服务器共享cookie                cookie.setPath("/");                response.addCookie(cookie);                return new Response(0, "登陆成功");            } else {                return new Response(1, map.get("msg"));            }        }catch (Exception e) {            logger.error("userLogin:" + e.getMessage());            return new Response(1, "登陆失败");        }    }    /**     * 用户退出     * @param token     * @return     */    @RequestMapping(path = "/logout", method = {RequestMethod.GET})    @ResponseBody    public Response userLogout(@CookieValue("auth_token") String token) {        try {            userService.logout(token);            return new Response(0, "退出成功");        } catch (Exception e) {            logger.error("userLogout:" + e.getMessage());            return new Response(1, "退出失败");        }    }    @RequestMapping(path = "/updateUser", method = {RequestMethod.POST})    @ResponseBody    public Response updateUser(@RequestBody String jsonStr, @CookieValue("auth_token") String auth_token) {        try {            Map<String, String> jsonMap = jsonUtils.StrToMap(jsonStr);            String nickname = jsonMap.get("nickname");            String password = jsonMap.get("password");            userService.updateUser(nickname, password, auth_token);            return new Response(0,"修改成功");        } catch (Exception e) {            logger.error("updateUser:" + e.getMessage());            return new Response(1, "修改失败");        }    }    /**     * 修改用户状态     * @param username     * @param status     * @return     */    @RequestMapping(path = "updateStatus", method = {RequestMethod.GET})    @ResponseBody    public Response updateUserStatus(@RequestParam("username") String username, @RequestParam("status") int status) {        try {            userService.updateStatus(username, status);            return new Response(0, "修改成功");        } catch (Exception e) {            logger.error("updateUserStatus:" + e.getMessage());            return new Response(1, "修改失败");        }    }}