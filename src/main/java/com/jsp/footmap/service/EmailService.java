package com.jsp.footmap.service;import com.jsp.footmap.controller.MailController;import com.jsp.footmap.dao.EmailDao;import com.jsp.footmap.model.Email;import com.jsp.footmap.model.Record;import com.jsp.footmap.utils.DateUtils;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.beans.factory.annotation.Value;import org.springframework.mail.SimpleMailMessage;import org.springframework.mail.javamail.JavaMailSender;import org.springframework.stereotype.Service;@Servicepublic class EmailService {    private static final Logger logger = LoggerFactory.getLogger(MailController.class);    @Autowired    private EmailDao emailDAO;    @Autowired    private JavaMailSender jms;    @Value("${spring.mail.username}")    private String username;    //判断email是否存在，存在了set code即可。    public void addEmail(String email, int code) {        Email existEmail = emailDAO.selectEmail(email);        //如果该邮箱存在,且已经成功注册(uid为0 代表注册未成功)        if (existEmail != null) {            if (existEmail.getUid() == 0){                //邮箱存在并且未绑定用户，只变更注册码                existEmail.setCode(code);                emailDAO.updateEmail(existEmail);            }        } else {            Email e = new Email();            e.setInputEmail(email);            e.setCode(code);            e.setUid(0);            emailDAO.addEmail(e);        }    }    /**     * 检查注册码是否正确     * @param email     * @param code     * @return     */    public int checkCode(String email, int code) {        int correctCode = emailDAO.selectCodeByEmail(email);        if (code == correctCode) {            return 1;        } else {            return 0;        }    }    /**     * 验证邮箱     * @param email     * @return     */    public int checkEmail(String email) {        Email existEmail = emailDAO.selectEmail(email);        if (existEmail != null && existEmail.getUid() != 0) {            return 0;        } else {            return 1;        }    }    /**     * 绑定邮箱     * @param uid     * @param email     */    public void fixEmail(int uid, String email) {        emailDAO.fixEmail(uid, email);    }    /**     * 根据uid查询邮箱     * @param uid     * @return     */    public String selectEmail(int uid) {        return emailDAO.selectEmailByUid(uid);    }    /**     * 提醒用户     * @param record     * @param email     */    public void remindUser(Record record, String email) {        try {            //创建邮件消息            SimpleMailMessage mainMessage = new SimpleMailMessage();            //发送者            mainMessage.setFrom(username);            //接收方            mainMessage.setTo(email);            //发送内容            mainMessage.setSubject(record.getTitle());            mainMessage.setText("您设置的于" + DateUtils.DateToString(record.getStartTime()) + "--"                    +  DateUtils.DateToString(record.getTargetTime()) + "之间的提醒需要完成了,主要内容是:在" +                    record.getTargetPlace() + "完成" + record.getRemarks() + "。请尽快完成!");            jms.send(mainMessage);            System.out.println("已完成发送！");        } catch (Exception e) {            e.printStackTrace();        }    }}